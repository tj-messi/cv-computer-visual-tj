# 基因匹配

## 基因数据匹配

将以下两个目录的spot-ST基因匹配

    /media/cbtil/T7 Shield/NMI/data/Visiumhdmousebrain4_8/spot_ST

    /media/cbtil/T7 Shield/NMI/data/Visium_mouse_brain/spot_ST

这两个目录基因分别叫做visiumhd和visium

其中visium的基因有30000+，visiumhd的基因有8000+

进行同名匹配：

![](https://cdn.jsdelivr.net/gh/tj-messi/picture/38b79ca734884968c576408e75d394a.png)

其中每20个进行匹配，如果有对不上的就直接全部舍弃

未匹配上的：

![](https://cdn.jsdelivr.net/gh/tj-messi/picture/1747483382940.png)

二次检查：

![](https://cdn.jsdelivr.net/gh/tj-messi/picture/1747483427254.png)


批量保存：

![](https://cdn.jsdelivr.net/gh/tj-messi/picture/1747483852217.png)

## test

    /media/cbtil/T7 Shield/NMI/code111111/sample_final_forvisium.py

数据传过来

    scp -r cbtil@10.241.64.165:"/media/cbtil/T7\ Shield/NMI/data/Visium_mouse_brain_matched"  /home/zeiler/NMI/data


修改：

    #data_root: '/home/cbtil/ST_proj/data/Breast_cancer/'
    data_root: '/home/zeiler/NMI/data/Visium_mouse_brain_matched/'

    args.all_gene    = 8000#（记得换）
    args.gene_num    = 20
    args.batch_size  = 1
    args.SR_times    = 10

    model_dirs = glob.glob(
        os.path.join("logsVisiumhdmousebrain",#(记得换)
                     f"{args.dataset_use}/{args.SR_times}X/G*")
    )

    # load patch info
    ds_info = Xenium5k2(
        data_root=args.data_root,
        dataset_use=args.dataset_use,
        SR_times=args.SR_times,
        status='Test',
        gene_num=args.gene_num,
        all_gene=args.all_gene,
        gene_order=gene_order,
        gene_name_order=gene_name_order
    )#（记得换）

下采样：

    pr = sample.permute(0,2,3,1).cpu().numpy()[0]
    pr = normalize_prediction(pr)      
    print(pr.shape)
    # 将 (256, 256, 20) 转换为 (1, 20, 256, 256)，N=1, C=20, H=256, W=256
    pr_tensor = torch.tensor(pr).unsqueeze(0).permute(0, 3, 1, 2)  # 变为 (1, 20, 256, 256)

    # 下采样：将尺寸缩小到目标大小 (26, 26)
    pr_resized = F.interpolate(pr_tensor, size=(26, 26), mode='bilinear', align_corners=False)

    # 将下采样后的张量转回 numpy 数组
    pr = pr_resized.squeeze(0).permute(1, 2, 0).cpu().numpy()  # 变回 (26, 26, 20)

    # save
    save_sample_images(hr, pr, pid, out_samps)

开始跑test

    /home/zeiler/NMI/code/sample_final_forvisium.py